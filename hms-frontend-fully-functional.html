<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hospital Management System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }
        
        .login-box {
            background: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            width: 100%;
            max-width: 400px;
        }
        
        .login-box h2 {
            margin-bottom: 30px;
            color: #333;
            text-align: center;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: 500;
        }
        
        .form-group input, 
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            width: 100%;
            transition: transform 0.2s;
        }
        
        .btn:hover {
            transform: translateY(-2px);
        }
        
        .btn-secondary {
            background: #6c757d;
        }
        
        .btn-success {
            background: #28a745;
        }
        
        .btn-danger {
            background: #dc3545;
        }
        
        .btn-warning {
            background: #ffc107;
            color: #333;
        }
        
        .btn-info {
            background: #17a2b8;
        }
        
        .container {
            display: none;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header h1 {
            color: #333;
            font-size: 24px;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .modules-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .module-card {
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }
        
        .module-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
        }
        
        .module-icon {
            font-size: 40px;
            margin-bottom: 15px;
        }
        
        .module-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
        }
        
        .module-description {
            color: #666;
            margin-bottom: 20px;
            font-size: 14px;
        }
        
        .module-actions {
            display: flex;
            gap: 10px;
        }
        
        .module-actions button {
            flex: 1;
            padding: 8px;
            font-size: 14px;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-header h3 {
            color: #333;
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #999;
        }
        
        .table-container {
            overflow-x: auto;
            margin: 20px 0;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        th {
            background: #f8f9fa;
            font-weight: bold;
            color: #333;
        }
        
        tr:hover {
            background: #f8f9fa;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: #667eea;
        }
        
        .stat-label {
            color: #666;
            margin-top: 5px;
        }
        
        .alert {
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
        }
        
        .search-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .search-bar input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        
        .badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .badge-success {
            background: #28a745;
            color: white;
        }
        
        .badge-warning {
            background: #ffc107;
            color: #333;
        }
        
        .badge-danger {
            background: #dc3545;
            color: white;
        }
        
        .badge-info {
            background: #17a2b8;
            color: white;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .ws-status {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }
        
        .ws-connected {
            background: #28a745;
        }
        
        .ws-disconnected {
            background: #dc3545;
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="login-container">
        <div class="login-box">
            <h2>üè• Hospital Management System</h2>
            <div id="loginAlert"></div>
            <form id="loginForm">
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="loginEmail" value="admin@hospital.com" required>
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="loginPassword" value="admin123" required>
                </div>
                <button type="submit" class="btn">Login</button>
            </form>
        </div>
    </div>

    <!-- Main Dashboard -->
    <div id="mainDashboard" class="container">
        <div class="header">
            <h1>üè• Hospital Management System</h1>
            <div class="user-info">
                <span>Welcome, <strong id="userName">Admin</strong></span>
                <span><span class="ws-status" id="wsStatus"></span>Live Updates</span>
                <button class="btn btn-secondary" onclick="logout()">Logout</button>
            </div>
        </div>

        <div class="modules-grid">
            <!-- Electronic Medical Records -->
            <div class="module-card">
                <div class="module-icon">üìã</div>
                <div class="module-title">Electronic Medical Records</div>
                <div class="module-description">Complete patient medical history, diagnoses, prescriptions, and lab results management.</div>
                <div class="module-actions">
                    <button class="btn btn-success" onclick="showNewPatientForm()">New Record</button>
                    <button class="btn btn-info" onclick="showPatientsList()">View Records</button>
                </div>
            </div>

            <!-- Billing & Revenue -->
            <div class="module-card">
                <div class="module-icon">üí∞</div>
                <div class="module-title">Billing & Revenue</div>
                <div class="module-description">Invoice generation, payment processing, insurance claims, and revenue tracking.</div>
                <div class="module-actions">
                    <button class="btn btn-success" onclick="showNewInvoiceForm()">Create Invoice</button>
                    <button class="btn btn-info" onclick="showInvoicesList()">View Invoices</button>
                </div>
            </div>

            <!-- Inventory Management -->
            <div class="module-card">
                <div class="module-icon">üì¶</div>
                <div class="module-title">Inventory Management</div>
                <div class="module-description">Track medications, medical supplies, equipment with automatic reorder alerts.</div>
                <div class="module-actions">
                    <button class="btn btn-success" onclick="showStockEntryForm()">Stock Entry</button>
                    <button class="btn btn-warning" onclick="showLowStockAlert()">Low Stock Alert</button>
                </div>
            </div>

            <!-- Staff Management -->
            <div class="module-card">
                <div class="module-icon">üë•</div>
                <div class="module-title">Staff Management</div>
                <div class="module-description">Staff scheduling, attendance tracking, payroll processing, and performance metrics.</div>
                <div class="module-actions">
                    <button class="btn btn-success" onclick="showAddScheduleForm()">Add Schedule</button>
                    <button class="btn btn-info" onclick="showStaffRoster()">View Roster</button>
                </div>
            </div>

            <!-- Bed Management -->
            <div class="module-card">
                <div class="module-icon">üõèÔ∏è</div>
                <div class="module-title">Bed Management</div>
                <div class="module-description">Real-time bed availability, admissions, discharges, and ward occupancy tracking.</div>
                <div class="module-actions">
                    <button class="btn btn-success" onclick="showNewAdmissionForm()">New Admission</button>
                    <button class="btn btn-info" onclick="showAvailableBeds()">Available Beds</button>
                </div>
            </div>

            <!-- Analytics Dashboard -->
            <div class="module-card">
                <div class="module-icon">üìä</div>
                <div class="module-title">Analytics Dashboard</div>
                <div class="module-description">Real-time metrics, occupancy trends, revenue analytics, and performance KPIs.</div>
                <div class="module-actions">
                    <button class="btn btn-info" onclick="showAnalyticsDashboard()">View Dashboard</button>
                    <button class="btn btn-warning" onclick="exportReport()">Export Report</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Modal Title</h3>
                <button class="close-modal" onclick="closeModal()">&times;</button>
            </div>
            <div id="modalBody">
                <!-- Dynamic content -->
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let authToken = localStorage.getItem('authToken');
        let currentUser = null;
        let ws = null;
        const API_URL = window.location.hostname === 'localhost' 
            ? 'http://localhost:5801/api'
            : `http://${window.location.hostname}:5801/api`;

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            if (authToken) {
                showDashboard();
                connectWebSocket();
            }
        });

        // Login form handler
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            try {
                const response = await fetch(`${API_URL}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    authToken = data.token;
                    currentUser = data.user;
                    localStorage.setItem('authToken', authToken);
                    showDashboard();
                    connectWebSocket();
                } else {
                    showAlert('loginAlert', 'Invalid credentials', 'error');
                }
            } catch (error) {
                showAlert('loginAlert', 'Connection error: ' + error.message, 'error');
            }
        });

        // WebSocket connection
        function connectWebSocket() {
            const wsUrl = window.location.hostname === 'localhost' 
                ? 'ws://localhost:5801'
                : `ws://${window.location.hostname}:5801`;
            
            ws = new WebSocket(wsUrl);
            
            ws.onopen = () => {
                document.getElementById('wsStatus').className = 'ws-status ws-connected';
            };
            
            ws.onclose = () => {
                document.getElementById('wsStatus').className = 'ws-status ws-disconnected';
                setTimeout(connectWebSocket, 5000);
            };
            
            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                handleRealtimeUpdate(data);
            };
        }

        // Handle realtime updates
        function handleRealtimeUpdate(data) {
            console.log('Realtime update:', data);
            // Refresh relevant views based on update type
            if (data.type === 'patient_added' || data.type === 'patient_updated') {
                if (document.getElementById('modalTitle').textContent.includes('Patients')) {
                    showPatientsList();
                }
            }
            // Add more update handlers as needed
        }

        // Show dashboard
        function showDashboard() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainDashboard').style.display = 'block';
            if (currentUser) {
                document.getElementById('userName').textContent = currentUser.name;
            }
        }

        // Logout
        function logout() {
            authToken = null;
            currentUser = null;
            localStorage.removeItem('authToken');
            if (ws) ws.close();
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('mainDashboard').style.display = 'none';
        }

        // Modal functions
        function showModal(title, content) {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalBody').innerHTML = content;
            document.getElementById('modal').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('modal').style.display = 'none';
        }

        // Alert function
        function showAlert(containerId, message, type) {
            const container = document.getElementById(containerId);
            container.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            setTimeout(() => {
                container.innerHTML = '';
            }, 5000);
        }

        // API helper
        async function apiCall(endpoint, method = 'GET', data = null) {
            const options = {
                method,
                headers: {
                    'Content-Type': 'application/json'
                }
            };

            if (authToken) {
                options.headers['Authorization'] = `Bearer ${authToken}`;
            }

            if (data) {
                options.body = JSON.stringify(data);
            }

            const response = await fetch(`${API_URL}${endpoint}`, options);
            return response.json();
        }

        // ============= PATIENT MANAGEMENT =============

        function showNewPatientForm() {
            const content = `
                <form id="newPatientForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label>First Name *</label>
                            <input type="text" id="firstName" required>
                        </div>
                        <div class="form-group">
                            <label>Last Name *</label>
                            <input type="text" id="lastName" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Date of Birth</label>
                            <input type="date" id="dateOfBirth">
                        </div>
                        <div class="form-group">
                            <label>Gender</label>
                            <select id="gender">
                                <option value="">Select...</option>
                                <option value="male">Male</option>
                                <option value="female">Female</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Phone</label>
                            <input type="tel" id="phone">
                        </div>
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" id="email">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Address</label>
                        <textarea id="address"></textarea>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Emergency Contact</label>
                            <input type="text" id="emergencyContact">
                        </div>
                        <div class="form-group">
                            <label>Emergency Phone</label>
                            <input type="tel" id="emergencyPhone">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Blood Group</label>
                            <select id="bloodGroup">
                                <option value="">Select...</option>
                                <option value="A+">A+</option>
                                <option value="A-">A-</option>
                                <option value="B+">B+</option>
                                <option value="B-">B-</option>
                                <option value="AB+">AB+</option>
                                <option value="AB-">AB-</option>
                                <option value="O+">O+</option>
                                <option value="O-">O-</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Allergies</label>
                            <input type="text" id="allergies" placeholder="Comma separated">
                        </div>
                    </div>
                    <div id="patientAlert"></div>
                    <button type="submit" class="btn btn-success">Add Patient</button>
                </form>
            `;
            
            showModal('New Patient Registration', content);

            document.getElementById('newPatientForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const patientData = {
                    firstName: document.getElementById('firstName').value,
                    lastName: document.getElementById('lastName').value,
                    dateOfBirth: document.getElementById('dateOfBirth').value,
                    gender: document.getElementById('gender').value,
                    phone: document.getElementById('phone').value,
                    email: document.getElementById('email').value,
                    address: document.getElementById('address').value,
                    emergencyContact: document.getElementById('emergencyContact').value,
                    emergencyPhone: document.getElementById('emergencyPhone').value,
                    bloodGroup: document.getElementById('bloodGroup').value,
                    allergies: document.getElementById('allergies').value
                };

                try {
                    const result = await apiCall('/patients', 'POST', patientData);
                    showAlert('patientAlert', 'Patient added successfully!', 'success');
                    setTimeout(() => {
                        showPatientsList();
                    }, 1500);
                } catch (error) {
                    showAlert('patientAlert', 'Error: ' + error.message, 'error');
                }
            });
        }

        async function showPatientsList() {
            const content = `
                <div class="search-bar">
                    <input type="text" id="patientSearch" placeholder="Search patients...">
                    <button class="btn btn-info" onclick="searchPatients()">Search</button>
                </div>
                <div class="loading" id="patientsLoading">
                    <div class="spinner"></div>
                </div>
                <div id="patientsTable"></div>
            `;
            
            showModal('Patient Records', content);
            document.getElementById('patientsLoading').style.display = 'block';

            try {
                const patients = await apiCall('/patients');
                const tableHtml = patients.length > 0 ? `
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Name</th>
                                <th>Age</th>
                                <th>Gender</th>
                                <th>Phone</th>
                                <th>Blood Group</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${patients.map(p => `
                                <tr>
                                    <td>${p.id}</td>
                                    <td>${p.first_name} ${p.last_name}</td>
                                    <td>${p.date_of_birth ? calculateAge(p.date_of_birth) : 'N/A'}</td>
                                    <td>${p.gender || 'N/A'}</td>
                                    <td>${p.phone || 'N/A'}</td>
                                    <td><span class="badge badge-info">${p.blood_group || 'N/A'}</span></td>
                                    <td>
                                        <button class="btn btn-info" onclick="viewPatientDetails(${p.id})">View</button>
                                        <button class="btn btn-warning" onclick="addMedicalRecord(${p.id})">Add Record</button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                ` : '<div class="empty-state">No patients found</div>';
                
                document.getElementById('patientsTable').innerHTML = tableHtml;
            } catch (error) {
                document.getElementById('patientsTable').innerHTML = `<div class="alert alert-error">Error loading patients</div>`;
            }
            
            document.getElementById('patientsLoading').style.display = 'none';
        }

        function calculateAge(dob) {
            const birthDate = new Date(dob);
            const today = new Date();
            let age = today.getFullYear() - birthDate.getFullYear();
            const monthDiff = today.getMonth() - birthDate.getMonth();
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
                age--;
            }
            return age;
        }

        async function viewPatientDetails(patientId) {
            try {
                const patient = await apiCall(`/patients/${patientId}`);
                const records = await apiCall(`/medical-records?patientId=${patientId}`);
                
                const content = `
                    <div class="patient-details">
                        <h4>Patient Information</h4>
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-label">Name</div>
                                <div class="stat-value" style="font-size: 20px">${patient.first_name} ${patient.last_name}</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">Age</div>
                                <div class="stat-value" style="font-size: 20px">${patient.date_of_birth ? calculateAge(patient.date_of_birth) : 'N/A'}</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">Blood Group</div>
                                <div class="stat-value" style="font-size: 20px">${patient.blood_group || 'N/A'}</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">Phone</div>
                                <div class="stat-value" style="font-size: 20px">${patient.phone || 'N/A'}</div>
                            </div>
                        </div>
                        
                        <h4>Medical History</h4>
                        ${records.length > 0 ? `
                            <table>
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Complaint</th>
                                        <th>Diagnosis</th>
                                        <th>Treatment</th>
                                        <th>Doctor</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${records.map(r => `
                                        <tr>
                                            <td>${new Date(r.visit_date).toLocaleDateString()}</td>
                                            <td>${r.chief_complaint || 'N/A'}</td>
                                            <td>${r.diagnosis || 'N/A'}</td>
                                            <td>${r.treatment || 'N/A'}</td>
                                            <td>${r.doctor_name || 'N/A'}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        ` : '<div class="empty-state">No medical records found</div>'}
                    </div>
                `;
                
                showModal(`Patient: ${patient.first_name} ${patient.last_name}`, content);
            } catch (error) {
                alert('Error loading patient details');
            }
        }

        function addMedicalRecord(patientId) {
            const content = `
                <form id="medicalRecordForm">
                    <input type="hidden" id="recordPatientId" value="${patientId}">
                    <div class="form-group">
                        <label>Chief Complaint</label>
                        <textarea id="chiefComplaint" required></textarea>
                    </div>
                    <div class="form-group">
                        <label>Diagnosis</label>
                        <textarea id="diagnosis" required></textarea>
                    </div>
                    <div class="form-group">
                        <label>Treatment</label>
                        <textarea id="treatment" required></textarea>
                    </div>
                    <div class="form-group">
                        <label>Prescription</label>
                        <textarea id="prescription"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Lab Results</label>
                        <textarea id="labResults"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Doctor Name</label>
                        <input type="text" id="doctorName" required>
                    </div>
                    <div class="form-group">
                        <label>Follow-up Date</label>
                        <input type="date" id="followUpDate">
                    </div>
                    <div class="form-group">
                        <label>Notes</label>
                        <textarea id="recordNotes"></textarea>
                    </div>
                    <div id="recordAlert"></div>
                    <button type="submit" class="btn btn-success">Save Medical Record</button>
                </form>
            `;
            
            showModal('Add Medical Record', content);
            
            document.getElementById('medicalRecordForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const recordData = {
                    patientId: document.getElementById('recordPatientId').value,
                    chiefComplaint: document.getElementById('chiefComplaint').value,
                    diagnosis: document.getElementById('diagnosis').value,
                    treatment: document.getElementById('treatment').value,
                    prescription: document.getElementById('prescription').value,
                    labResults: document.getElementById('labResults').value,
                    doctorName: document.getElementById('doctorName').value,
                    followUpDate: document.getElementById('followUpDate').value,
                    notes: document.getElementById('recordNotes').value
                };
                
                try {
                    await apiCall('/medical-records', 'POST', recordData);
                    showAlert('recordAlert', 'Medical record added successfully!', 'success');
                    setTimeout(closeModal, 1500);
                } catch (error) {
                    showAlert('recordAlert', 'Error: ' + error.message, 'error');
                }
            });
        }

        // ============= BILLING MANAGEMENT =============

        function showNewInvoiceForm() {
            const content = `
                <form id="newInvoiceForm">
                    <div class="form-group">
                        <label>Patient ID *</label>
                        <input type="number" id="invoicePatientId" required>
                    </div>
                    <div id="invoiceItems">
                        <h4>Invoice Items</h4>
                        <div class="invoice-item">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Description</label>
                                    <input type="text" class="item-description" required>
                                </div>
                                <div class="form-group">
                                    <label>Amount</label>
                                    <input type="number" class="item-amount" required>
                                </div>
                                <div class="form-group">
                                    <label>Quantity</label>
                                    <input type="number" class="item-quantity" value="1" required>
                                </div>
                            </div>
                        </div>
                    </div>
                    <button type="button" class="btn btn-info" onclick="addInvoiceItem()">Add Item</button>
                    
                    <div class="form-row" style="margin-top: 20px;">
                        <div class="form-group">
                            <label>Payment Method</label>
                            <select id="paymentMethod">
                                <option value="cash">Cash</option>
                                <option value="card">Card</option>
                                <option value="insurance">Insurance</option>
                                <option value="nhis">NHIS</option>
                                <option value="hmo">HMO</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Due Date</label>
                            <input type="date" id="dueDate">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Insurance Claim Number (if applicable)</label>
                        <input type="text" id="insuranceClaim">
                    </div>
                    
                    <div id="invoiceAlert"></div>
                    <button type="submit" class="btn btn-success">Create Invoice</button>
                </form>
            `;
            
            showModal('Create New Invoice', content);
            
            document.getElementById('newInvoiceForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const items = [];
                document.querySelectorAll('.invoice-item').forEach(item => {
                    items.push({
                        description: item.querySelector('.item-description').value,
                        amount: parseFloat(item.querySelector('.item-amount').value),
                        quantity: parseInt(item.querySelector('.item-quantity').value)
                    });
                });
                
                const invoiceData = {
                    patientId: document.getElementById('invoicePatientId').value,
                    items: items,
                    paymentMethod: document.getElementById('paymentMethod').value,
                    dueDate: document.getElementById('dueDate').value,
                    insuranceClaim: document.getElementById('insuranceClaim').value
                };
                
                try {
                    const result = await apiCall('/invoices', 'POST', invoiceData);
                    showAlert('invoiceAlert', `Invoice #${result.invoice_number} created successfully!`, 'success');
                    setTimeout(() => {
                        showInvoicesList();
                    }, 1500);
                } catch (error) {
                    showAlert('invoiceAlert', 'Error: ' + error.message, 'error');
                }
            });
        }

        function addInvoiceItem() {
            const itemDiv = document.createElement('div');
            itemDiv.className = 'invoice-item';
            itemDiv.innerHTML = `
                <div class="form-row">
                    <div class="form-group">
                        <label>Description</label>
                        <input type="text" class="item-description" required>
                    </div>
                    <div class="form-group">
                        <label>Amount</label>
                        <input type="number" class="item-amount" required>
                    </div>
                    <div class="form-group">
                        <label>Quantity</label>
                        <input type="number" class="item-quantity" value="1" required>
                    </div>
                </div>
            `;
            document.getElementById('invoiceItems').appendChild(itemDiv);
        }

        async function showInvoicesList() {
            const content = `
                <div class="loading" id="invoicesLoading">
                    <div class="spinner"></div>
                </div>
                <div id="invoicesTable"></div>
            `;
            
            showModal('Invoices', content);
            document.getElementById('invoicesLoading').style.display = 'block';

            try {
                const invoices = await apiCall('/invoices');
                const tableHtml = invoices.length > 0 ? `
                    <table>
                        <thead>
                            <tr>
                                <th>Invoice #</th>
                                <th>Patient</th>
                                <th>Amount</th>
                                <th>Method</th>
                                <th>Status</th>
                                <th>Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${invoices.map(inv => `
                                <tr>
                                    <td>${inv.invoice_number}</td>
                                    <td>${inv.first_name || ''} ${inv.last_name || ''}</td>
                                    <td>‚Ç¶${parseFloat(inv.total_amount).toLocaleString()}</td>
                                    <td>${inv.payment_method}</td>
                                    <td>
                                        <span class="badge ${inv.payment_status === 'paid' ? 'badge-success' : 'badge-warning'}">
                                            ${inv.payment_status}
                                        </span>
                                    </td>
                                    <td>${new Date(inv.created_at).toLocaleDateString()}</td>
                                    <td>
                                        ${inv.payment_status === 'pending' ? 
                                            `<button class="btn btn-success" onclick="processPayment(${inv.id}, ${inv.total_amount})">Pay</button>` :
                                            `<button class="btn btn-info" onclick="viewInvoice(${inv.id})">View</button>`
                                        }
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                ` : '<div class="empty-state">No invoices found</div>';
                
                document.getElementById('invoicesTable').innerHTML = tableHtml;
            } catch (error) {
                document.getElementById('invoicesTable').innerHTML = `<div class="alert alert-error">Error loading invoices</div>`;
            }
            
            document.getElementById('invoicesLoading').style.display = 'none';
        }

        async function processPayment(invoiceId, amount) {
            const content = `
                <form id="paymentForm">
                    <div class="form-group">
                        <label>Invoice Amount</label>
                        <input type="text" value="‚Ç¶${parseFloat(amount).toLocaleString()}" disabled>
                    </div>
                    <div class="form-group">
                        <label>Payment Amount</label>
                        <input type="number" id="paymentAmount" value="${amount}" required>
                    </div>
                    <div class="form-group">
                        <label>Payment Method</label>
                        <select id="payMethod" required>
                            <option value="cash">Cash</option>
                            <option value="card">Card</option>
                            <option value="bank_transfer">Bank Transfer</option>
                            <option value="insurance">Insurance</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Transaction ID</label>
                        <input type="text" id="transactionId">
                    </div>
                    <div class="form-group">
                        <label>Notes</label>
                        <textarea id="paymentNotes"></textarea>
                    </div>
                    <div id="paymentAlert"></div>
                    <button type="submit" class="btn btn-success">Process Payment</button>
                </form>
            `;
            
            showModal('Process Payment', content);
            
            document.getElementById('paymentForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const paymentData = {
                    invoiceId: invoiceId,
                    amount: document.getElementById('paymentAmount').value,
                    method: document.getElementById('payMethod').value,
                    transactionId: document.getElementById('transactionId').value,
                    notes: document.getElementById('paymentNotes').value
                };
                
                try {
                    await apiCall('/payments', 'POST', paymentData);
                    showAlert('paymentAlert', 'Payment processed successfully!', 'success');
                    setTimeout(() => {
                        showInvoicesList();
                    }, 1500);
                } catch (error) {
                    showAlert('paymentAlert', 'Error: ' + error.message, 'error');
                }
            });
        }

        // ============= INVENTORY MANAGEMENT =============

        function showStockEntryForm() {
            const content = `
                <form id="stockEntryForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Item Name *</label>
                            <input type="text" id="itemName" required>
                        </div>
                        <div class="form-group">
                            <label>Category *</label>
                            <select id="itemCategory" required>
                                <option value="medication">Medication</option>
                                <option value="equipment">Equipment</option>
                                <option value="consumable">Consumable</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Quantity *</label>
                            <input type="number" id="itemQuantity" required>
                        </div>
                        <div class="form-group">
                            <label>Unit *</label>
                            <input type="text" id="itemUnit" placeholder="e.g., tablets, bottles" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Reorder Level</label>
                            <input type="number" id="reorderLevel" value="10">
                        </div>
                        <div class="form-group">
                            <label>Price per Unit</label>
                            <input type="number" id="itemPrice" step="0.01">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Supplier</label>
                            <input type="text" id="supplier">
                        </div>
                        <div class="form-group">
                            <label>Batch Number</label>
                            <input type="text" id="batchNumber">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Expiry Date</label>
                            <input type="date" id="expiryDate">
                        </div>
                        <div class="form-group">
                            <label>Storage Location</label>
                            <input type="text" id="location">
                        </div>
                    </div>
                    
                    <div id="stockAlert"></div>
                    <button type="submit" class="btn btn-success">Add Stock</button>
                </form>
            `;
            
            showModal('Stock Entry', content);
            
            document.getElementById('stockEntryForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const stockData = {
                    name: document.getElementById('itemName').value,
                    category: document.getElementById('itemCategory').value,
                    quantity: document.getElementById('itemQuantity').value,
                    unit: document.getElementById('itemUnit').value,
                    reorderLevel: document.getElementById('reorderLevel').value,
                    price: document.getElementById('itemPrice').value,
                    supplier: document.getElementById('supplier').value,
                    batchNumber: document.getElementById('batchNumber').value,
                    expiryDate: document.getElementById('expiryDate').value,
                    location: document.getElementById('location').value
                };
                
                try {
                    await apiCall('/inventory', 'POST', stockData);
                    showAlert('stockAlert', 'Stock added successfully!', 'success');
                    setTimeout(closeModal, 1500);
                } catch (error) {
                    showAlert('stockAlert', 'Error: ' + error.message, 'error');
                }
            });
        }

        async function showLowStockAlert() {
            const content = `
                <div class="loading" id="stockLoading">
                    <div class="spinner"></div>
                </div>
                <div id="stockTable"></div>
            `;
            
            showModal('Low Stock Alert', content);
            document.getElementById('stockLoading').style.display = 'block';

            try {
                const items = await apiCall('/inventory/low-stock');
                const tableHtml = items.length > 0 ? `
                    <div class="alert alert-warning">‚ö†Ô∏è ${items.length} items need restocking</div>
                    <table>
                        <thead>
                            <tr>
                                <th>Item</th>
                                <th>Category</th>
                                <th>Current Stock</th>
                                <th>Reorder Level</th>
                                <th>Supplier</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${items.map(item => `
                                <tr>
                                    <td>${item.name}</td>
                                    <td>${item.category}</td>
                                    <td><span class="badge badge-danger">${item.quantity} ${item.unit}</span></td>
                                    <td>${item.reorder_level} ${item.unit}</td>
                                    <td>${item.supplier || 'N/A'}</td>
                                    <td>
                                        <button class="btn btn-success" onclick="reorderItem(${item.id})">Reorder</button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                ` : '<div class="empty-state">‚úÖ All items are well stocked</div>';
                
                document.getElementById('stockTable').innerHTML = tableHtml;
            } catch (error) {
                document.getElementById('stockTable').innerHTML = `<div class="alert alert-error">Error loading stock levels</div>`;
            }
            
            document.getElementById('stockLoading').style.display = 'none';
        }

        // ============= STAFF MANAGEMENT =============

        function showAddScheduleForm() {
            const content = `
                <form id="scheduleForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Staff Name *</label>
                            <input type="text" id="staffName" required>
                        </div>
                        <div class="form-group">
                            <label>Department *</label>
                            <select id="department" required>
                                <option value="Emergency">Emergency</option>
                                <option value="ICU">ICU</option>
                                <option value="General Ward">General Ward</option>
                                <option value="Pediatrics">Pediatrics</option>
                                <option value="Surgery">Surgery</option>
                                <option value="Outpatient">Outpatient</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Shift Start *</label>
                            <input type="datetime-local" id="shiftStart" required>
                        </div>
                        <div class="form-group">
                            <label>Shift End *</label>
                            <input type="datetime-local" id="shiftEnd" required>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Notes</label>
                        <textarea id="scheduleNotes"></textarea>
                    </div>
                    
                    <div id="scheduleAlert"></div>
                    <button type="submit" class="btn btn-success">Add Schedule</button>
                </form>
            `;
            
            showModal('Add Staff Schedule', content);
            
            document.getElementById('scheduleForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const scheduleData = {
                    staffId: 1, // This should be dynamic in production
                    staffName: document.getElementById('staffName').value,
                    department: document.getElementById('department').value,
                    shiftStart: document.getElementById('shiftStart').value,
                    shiftEnd: document.getElementById('shiftEnd').value,
                    notes: document.getElementById('scheduleNotes').value
                };
                
                try {
                    await apiCall('/schedules', 'POST', scheduleData);
                    showAlert('scheduleAlert', 'Schedule added successfully!', 'success');
                    setTimeout(() => {
                        showStaffRoster();
                    }, 1500);
                } catch (error) {
                    showAlert('scheduleAlert', 'Error: ' + error.message, 'error');
                }
            });
        }

        async function showStaffRoster() {
            const content = `
                <div class="loading" id="rosterLoading">
                    <div class="spinner"></div>
                </div>
                <div id="rosterTable"></div>
            `;
            
            showModal('Staff Roster', content);
            document.getElementById('rosterLoading').style.display = 'block';

            try {
                const schedules = await apiCall('/schedules');
                const tableHtml = schedules.length > 0 ? `
                    <table>
                        <thead>
                            <tr>
                                <th>Staff</th>
                                <th>Department</th>
                                <th>Shift Start</th>
                                <th>Shift End</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${schedules.map(s => `
                                <tr>
                                    <td>${s.staff_name}</td>
                                    <td>${s.department}</td>
                                    <td>${new Date(s.shift_start).toLocaleString()}</td>
                                    <td>${new Date(s.shift_end).toLocaleString()}</td>
                                    <td>
                                        <span class="badge ${s.status === 'completed' ? 'badge-success' : 'badge-info'}">
                                            ${s.status}
                                        </span>
                                    </td>
                                    <td>
                                        <button class="btn btn-info" onclick="viewScheduleDetails(${s.id})">View</button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                ` : '<div class="empty-state">No schedules found</div>';
                
                document.getElementById('rosterTable').innerHTML = tableHtml;
            } catch (error) {
                document.getElementById('rosterTable').innerHTML = `<div class="alert alert-error">Error loading roster</div>`;
            }
            
            document.getElementById('rosterLoading').style.display = 'none';
        }

        // ============= BED MANAGEMENT =============

        function showNewAdmissionForm() {
            const content = `
                <form id="admissionForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Patient ID *</label>
                            <input type="number" id="admPatientId" required>
                        </div>
                        <div class="form-group">
                            <label>Ward *</label>
                            <select id="wardId" required>
                                <option value="1">General Ward A</option>
                                <option value="2">ICU</option>
                                <option value="3">Pediatric Ward</option>
                                <option value="4">Maternity Ward</option>
                                <option value="5">Emergency Ward</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Bed Number *</label>
                        <input type="number" id="bedId" required>
                    </div>
                    
                    <div class="form-group">
                        <label>Diagnosis *</label>
                        <textarea id="admDiagnosis" required></textarea>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Admitting Doctor *</label>
                            <input type="text" id="admittingDoctor" required>
                        </div>
                        <div class="form-group">
                            <label>Attending Doctor</label>
                            <input type="text" id="attendingDoctor">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Notes</label>
                        <textarea id="admissionNotes"></textarea>
                    </div>
                    
                    <div id="admissionAlert"></div>
                    <button type="submit" class="btn btn-success">Admit Patient</button>
                </form>
            `;
            
            showModal('New Admission', content);
            
            document.getElementById('admissionForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const admissionData = {
                    patientId: document.getElementById('admPatientId').value,
                    wardId: document.getElementById('wardId').value,
                    bedId: document.getElementById('bedId').value,
                    diagnosis: document.getElementById('admDiagnosis').value,
                    admittingDoctor: document.getElementById('admittingDoctor').value,
                    attendingDoctor: document.getElementById('attendingDoctor').value,
                    notes: document.getElementById('admissionNotes').value
                };
                
                try {
                    await apiCall('/admissions', 'POST', admissionData);
                    showAlert('admissionAlert', 'Patient admitted successfully!', 'success');
                    setTimeout(() => {
                        showAvailableBeds();
                    }, 1500);
                } catch (error) {
                    showAlert('admissionAlert', 'Error: ' + error.message, 'error');
                }
            });
        }

        async function showAvailableBeds() {
            const content = `
                <div class="loading" id="bedsLoading">
                    <div class="spinner"></div>
                </div>
                <div id="bedsContent"></div>
            `;
            
            showModal('Bed Availability', content);
            document.getElementById('bedsLoading').style.display = 'block';

            try {
                const [beds, occupancy] = await Promise.all([
                    apiCall('/beds/available'),
                    apiCall('/wards/occupancy')
                ]);
                
                const content = `
                    <div class="stats-grid">
                        ${occupancy.map(ward => `
                            <div class="stat-card">
                                <div class="stat-label">${ward.name}</div>
                                <div class="stat-value">${ward.occupancy_rate || 0}%</div>
                                <small>${ward.occupied}/${ward.capacity} beds occupied</small>
                            </div>
                        `).join('')}
                    </div>
                    
                    <h4>Available Beds</h4>
                    ${beds.length > 0 ? `
                        <table>
                            <thead>
                                <tr>
                                    <th>Bed Number</th>
                                    <th>Ward</th>
                                    <th>Type</th>
                                    <th>Floor</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${beds.map(bed => `
                                    <tr>
                                        <td>${bed.bed_number}</td>
                                        <td>${bed.ward_name}</td>
                                        <td>${bed.ward_type}</td>
                                        <td>${bed.floor}</td>
                                        <td>
                                            <button class="btn btn-success" onclick="assignBed(${bed.id})">Assign</button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    ` : '<div class="empty-state">No beds available</div>'}
                `;
                
                document.getElementById('bedsContent').innerHTML = content;
            } catch (error) {
                document.getElementById('bedsContent').innerHTML = `<div class="alert alert-error">Error loading bed status</div>`;
            }
            
            document.getElementById('bedsLoading').style.display = 'none';
        }

        // ============= ANALYTICS =============

        async function showAnalyticsDashboard() {
            const content = `
                <div class="loading" id="analyticsLoading">
                    <div class="spinner"></div>
                </div>
                <div id="analyticsContent"></div>
            `;
            
            showModal('Analytics Dashboard', content);
            document.getElementById('analyticsLoading').style.display = 'block';

            try {
                const [dashboard, revenue, trends] = await Promise.all([
                    apiCall('/analytics/dashboard'),
                    apiCall('/analytics/revenue'),
                    apiCall('/analytics/occupancy-trends')
                ]);
                
                const content = `
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value">${dashboard.totalPatients}</div>
                            <div class="stat-label">Total Patients</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">‚Ç¶${dashboard.totalRevenue.toLocaleString()}</div>
                            <div class="stat-label">Total Revenue</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${dashboard.activeAdmissions}</div>
                            <div class="stat-label">Active Admissions</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${dashboard.occupancyRate}%</div>
                            <div class="stat-label">Occupancy Rate</div>
                        </div>
                    </div>
                    
                    <h4>Revenue Summary</h4>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value" style="color: #28a745">‚Ç¶${revenue.total.toLocaleString()}</div>
                            <div class="stat-label">Paid</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" style="color: #ffc107">‚Ç¶${revenue.pending.toLocaleString()}</div>
                            <div class="stat-label">Pending</div>
                        </div>
                    </div>
                    
                    <h4>Recent Trends</h4>
                    ${trends.length > 0 ? `
                        <table>
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Admissions</th>
                                    <th>Discharges</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${trends.slice(0, 7).map(t => `
                                    <tr>
                                        <td>${new Date(t.date).toLocaleDateString()}</td>
                                        <td>${t.admissions}</td>
                                        <td>${t.discharges}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    ` : '<div class="empty-state">No trend data available</div>'}
                `;
                
                document.getElementById('analyticsContent').innerHTML = content;
            } catch (error) {
                document.getElementById('analyticsContent').innerHTML = `<div class="alert alert-error">Error loading analytics</div>`;
            }
            
            document.getElementById('analyticsLoading').style.display = 'none';
        }

        async function exportReport() {
            try {
                const report = await apiCall('/analytics/export?type=full');
                
                const content = `
                    <h4>Report Generated</h4>
                    <div class="alert alert-success">Report generated successfully!</div>
                    
                    <h5>Summary</h5>
                    <pre>${JSON.stringify(report.summary, null, 2)}</pre>
                    
                    ${report.detailed ? `
                        <h5>Recent Patients</h5>
                        <pre>${JSON.stringify(report.detailed.recentPatients.slice(0, 5), null, 2)}</pre>
                    ` : ''}
                    
                    <button class="btn btn-success" onclick="downloadReport('${btoa(JSON.stringify(report))}')">Download JSON</button>
                `;
                
                showModal('Export Report', content);
            } catch (error) {
                alert('Error generating report: ' + error.message);
            }
        }

        function downloadReport(data) {
            const blob = new Blob([atob(data)], { type: 'application/json' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `hospital-report-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        // Window click to close modal
        window.onclick = function(event) {
            const modal = document.getElementById('modal');
            if (event.target === modal) {
                closeModal();
            }
        };
    </script>
</body>
</html>
